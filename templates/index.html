<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éˆæ©Ÿä¸€å‹• - æ˜“ç¶“å åœ</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;700&family=Zen+Maru+Gothic:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div x-data="app()">
        <div class="bg-orb orb-1"></div>
        <div class="bg-orb orb-2"></div>

        <header>
            <div class="brand" @click="goHome()">
                <i class="fas fa-yin-yang fa-spin" style="animation-duration: 10s;"></i> éˆæ©Ÿä¸€å‹•
            </div>
            <nav class="nav-menu">
                <template x-if="currentUser">
                    <div class="nav-item" style="color:var(--primary-gold); cursor:default;">
                        <i class="fas fa-user"></i> <span x-text="currentUser.username"></span>
                    </div>
                </template>
                <template x-if="currentUser && currentUser.role === 'admin'">
                    <div class="nav-item" @click="fetchUsers(); activeModal = 'admin'">
                        <i class="fas fa-users-cog"></i> <span>ç®¡ç†</span>
                    </div>
                </template>
                <div class="nav-item"
                    @click="fetchHistory(); if(currentUser && currentUser.role === 'admin') fetchUsers(); activeModal = 'history'">
                    <i class="fas fa-history"></i> <span>æ­·å²</span>
                </div>
                <div class="nav-item" @click="activeModal = 'tutorial'">
                    <i class="fas fa-book-open"></i> <span>æ•™å­¸</span>
                </div>
                <div class="nav-item" @click="fetchSettings(); activeModal = 'settings'">
                    <i class="fas fa-cog"></i> <span>è¨­å®š</span>
                </div>
                <template x-if="currentUser">
                    <div class="nav-item" @click="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                </template>
            </nav>
        </header>

        <main>
            <!-- Main Content -->
            <div class="content-wrapper" x-show="!resultMode && currentUser">
                <div class="divine-container">
                    <h1 class="main-title">èª å¿ƒå åœ</h1>
                    <p class="sub-title">å¤©æ©Ÿä¸å¯æ´©éœ²ï¼Œå”¯èª è€…å¯å¾—ä¹‹</p>
                    <div class="input-card">
                        <textarea class="elegant-input" x-model="question" :placeholder="placeholderText"
                            @input="$el.style.height = ''; $el.style.height = Math.min($el.scrollHeight, 200) + 'px'"></textarea>
                    </div>
                    <button class="action-btn" @click="performDivination()" :disabled="loading">
                        <template x-if="!loading"><span>é–‹å§‹èµ·å¦</span></template>
                        <template x-if="loading"><span><i class="fas fa-circle-notch fa-spin"></i> æ¼”ç®—ä¸­</span></template>
                    </button>
                    <div style="margin-top:20px;">
                        <span @click="randomQuestion()"
                            style="color:var(--text-muted); font-size:0.9rem; cursor:pointer; border-bottom:1px dashed var(--text-muted);">
                            ä¸çŸ¥å•ä»€éº¼ï¼Ÿè©¦è©¦éˆæ„Ÿ
                        </span>
                    </div>
                    <p x-show="errorMessage" x-text="errorMessage"
                        style="color: #c0392b; margin-top: 20px; font-weight: bold;"></p>
                </div>
            </div>

            <!-- Result View -->
            <div class="modal-layer" x-show="resultMode" x-transition.opacity>
                <div class="glass-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-star"></i> å¦è±¡è§£æ</h2>
                        <div style="flex-grow:1;"></div>
                        <div class="status-indicator" title="æ’ç›¤">
                            <div class="status-dot"
                                :class="toolStatus.get_divination_tool == 'success' ? 'success' : (toolStatus.get_divination_tool == 'error' ? 'error' : '')">
                            </div><span>æ’ç›¤</span>
                        </div>
                        <div class="status-indicator" title="å¤©æ™‚">
                            <div class="status-dot"
                                :class="toolStatus.get_current_time == 'success' ? 'success' : (toolStatus.get_current_time == 'error' ? 'error' : '')">
                            </div><span>å¤©æ™‚</span>
                        </div>
                        <button class="panel-close" @click="resultMode = false; goHome()"><i
                                class="fas fa-times"></i></button>
                    </div>
                    <div class="panel-content">
                        <div
                            style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px;">
                            <strong style="color:var(--primary-gold);">å•é¡Œï¼š</strong>
                            <span x-text="lastQuestion"></span>
                        </div>
                        <!-- Results Content -->
                        <div class="result-display-area">
                            <!-- Think Box -->
                            <template x-if="thinkContent">
                                <details class="think-details">
                                    <summary class="think-summary">
                                        <i class="fas fa-brain"></i> å¤§å¸«æ€è€ƒéç¨‹ (é»æ“Šå±•é–‹)
                                    </summary>
                                    <div class="think-content" x-text="thinkContent"></div>
                                </details>
                            </template>

                            <!-- Structured Result -->
                            <template x-if="structuredData">
                                <div class="structured-container">
                                    <div class="summary-banner" x-text="structuredData.summary"></div>

                                    <div class="overview-header">
                                        <div class="overview-title" x-text="structuredData.overview.title"></div>
                                        <div class="overview-meaning" x-text="structuredData.overview.meaning"></div>
                                    </div>

                                    <template x-for="sec in structuredData.sections" :key="sec.title">
                                        <div class="analysis-section">
                                            <div class="section-title" x-text="sec.title"></div>
                                            <div class="section-body" x-text="sec.content"></div>
                                        </div>
                                    </template>

                                    <div class="guidance-box">
                                        <div class="conclusion-badge" x-text="structuredData.guidance.conclusion"></div>
                                        <ul class="suggestion-list">
                                            <template x-for="sug in structuredData.guidance.suggestions" :key="sug">
                                                <li class="suggestion-item" x-text="sug"></li>
                                            </template>
                                        </ul>
                                        <div class="motto-box" x-text="structuredData.guidance.motto"></div>
                                    </div>
                                </div>
                            </template>

                            <!-- Legacy/Markdown Result -->
                            <template x-if="!structuredData">
                                <div class="markdown-content" x-html="parsedResult"></div>
                            </template>
                        </div>
                    </div>
                    <div style="padding:20px 30px; text-align:right; border-top:1px solid rgba(255,255,255,0.05);">
                        <button class="action-btn" style="padding: 8px 24px; font-size:1rem;"
                            @click="copyResult()">è¤‡è£½çµæœ</button>
                    </div>
                </div>
            </div>

            <!-- Tossing Modal -->
            <div class="modal-layer" x-show="tossingMode" style="background: rgba(0,0,0,0.9);" x-transition.opacity>
                <div class="glass-panel" style="text-align:center; max-width:400px;">
                    <h2 class="animate-pulse" style="margin-bottom:20px; color:var(--primary-gold);"><i
                            class="fas fa-dice-d6 fa-spin"></i> èª å¿ƒæ–å¦ä¸­...</h2>
                    <div
                        style="display:flex; flex-direction:column-reverse; gap:10px; margin:20px 0; align-items:center;">
                        <template x-for="(coin, index) in currentCoins" :key="index">
                            <div class="coin-row" x-transition>
                                <span style="font-size:0.8rem; color:var(--text-muted); margin-right:10px;"
                                    x-text="'ç¬¬ ' + (index+1) + ' çˆ»'"></span>
                                <div class="coin-visual" :class="getCoinClass(coin)"><span
                                        x-text="getCoinLabel(coin)"></span></div>
                            </div>
                        </template>
                    </div>
                    <div x-show="currentCoins.length === 6" style="margin-top:20px;">
                        <p class="fade-in">å¦è±¡å·²å®šï¼Œæ­£åœ¨è§£ç›¤...</p>
                    </div>
                </div>
            </div>

            <!-- Login/Register Modal -->
            <div class="modal-layer" x-show="activeModal === 'login'" style="z-index:999;" x-transition.opacity>
                <div class="glass-panel" style="max-width:400px;">
                    <div class="panel-header">
                        <h2 x-show="authMode === 'login'"><i class="fas fa-sign-in-alt"></i> ç™»å…¥ç³»çµ±</h2>
                        <h2 x-show="authMode === 'register'"><i class="fas fa-user-plus"></i> å‰µå»ºå¸³è™Ÿ</h2>
                    </div>
                    <div class="panel-content">
                        <!-- Login Form -->
                        <form x-show="authMode === 'login'" @submit.prevent="login()">
                            <div class="setting-item">
                                <label>å¸³è™Ÿ</label>
                                <input type="text" x-model="loginForm.username" required class="auth-input">
                            </div>
                            <div class="setting-item">
                                <label>å¯†ç¢¼</label>
                                <input type="password" x-model="loginForm.password" required class="auth-input">
                            </div>
                            <div style="text-align:right; margin-top:20px;">
                                <button type="submit" class="action-btn" style="padding:10px 30px;">ç™»å…¥</button>
                            </div>
                            <p style="text-align:center; margin-top:20px; font-size:0.9rem;">
                                æ²’æœ‰å¸³è™Ÿï¼Ÿ <span @click="authMode = 'register'"
                                    style="color:var(--primary-gold); cursor:pointer; text-decoration:underline;">ç«‹å³è¨»å†Š</span>
                            </p>
                        </form>

                        <!-- Register Form -->
                        <form x-show="authMode === 'register'" @submit.prevent="register()">
                            <div class="setting-item">
                                <label>ç”¨æˆ¶å</label>
                                <input type="text" x-model="registerForm.username" required class="auth-input">
                            </div>
                            <div class="setting-item">
                                <label>å¯†ç¢¼ (è‡³å°‘6å­—)</label>
                                <input type="password" x-model="registerForm.password" required minlength="6"
                                    class="auth-input">
                            </div>
                            <div style="text-align:right; margin-top:20px;">
                                <button type="submit" class="action-btn" style="padding:10px 30px;">è¨»å†Šä¸¦ç™»å…¥</button>
                            </div>
                            <p style="text-align:center; margin-top:20px; font-size:0.9rem;">
                                å·²æœ‰å¸³è™Ÿï¼Ÿ <span @click="authMode = 'login'"
                                    style="color:var(--primary-gold); cursor:pointer; text-decoration:underline;">è¿”å›ç™»å…¥</span>
                            </p>
                        </form>
                    </div>
                </div>
            </div>

            <!-- History Modal -->
            <div class="modal-layer" x-show="activeModal === 'history'" @click.self="activeModal = null"
                x-transition.opacity>
                <div class="glass-panel">
                    <div class="panel-header">
                        <h2>æ­·å²ç´€éŒ„</h2>
                        <button class="panel-close" @click="activeModal = null"><i class="fas fa-times"></i></button>
                    </div>

                    <!-- Admin Filter -->
                    <template x-if="currentUser && currentUser.role === 'admin'">
                        <div
                            style="padding: 10px 20px; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 0.9rem; color: var(--text-muted);">æŸ¥çœ‹ä½¿ç”¨è€…ï¼š</label>
                            <select x-model="historyUserId" @change="fetchHistory()" class="elegant-select"
                                style="padding: 4px 10px; font-size: 0.9rem; background: var(--panel-bg); border-color: rgba(255,255,255,0.2);">
                                <option value="all">å…¨éƒ¨ä½¿ç”¨è€…</option>
                                <template x-for="u in allUsers" :key="u.id">
                                    <option :value="u.id" x-text="u.username"></option>
                                </template>
                            </select>
                        </div>
                    </template>

                    <div class="panel-content" style="padding:0;">
                        <div x-show="historyList.length === 0"
                            style="padding:40px; text-align:center; color:var(--text-muted);">æš«ç„¡æ­·å²ç´€éŒ„</div>
                        <template x-for="item in historyList" :key="item.id">
                            <div class="history-row">
                                <div @click="showResult(item); activeModal = null" style="flex-grow:1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <div style="color:var(--text-main); font-size:1.1rem;"
                                            x-text="item.question || '(ç„¡é¡Œ)'"></div>
                                        <template x-if="item.username">
                                            <span
                                                style="font-size: 0.75rem; padding: 2px 6px; background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 4px; color: var(--primary-gold);"
                                                x-text="item.username"></span>
                                        </template>
                                    </div>
                                    <div class="row-date" x-text="item.created_at"></div>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button @click="toggleFavorite(item)"
                                        style="background:none; border:none; cursor:pointer; font-size:1.2rem;">
                                        <i :class="item.is_favorite ? 'fas fa-heart' : 'far fa-heart'"
                                            :style="item.is_favorite ? 'color:#c0392b' : 'color:var(--text-muted)'"></i>
                                    </button>
                                    <button @click="deleteHistory(item)"
                                        style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--text-muted);"><i
                                            class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Tutorial Modal -->
            <div class="modal-layer" x-show="activeModal === 'tutorial'"
                @click.self="tutorialSeen ? activeModal = null : null" x-transition.opacity>
                <div class="glass-panel" style="max-width:700px;">
                    <div class="panel-header">
                        <h2><i class="fas fa-graduation-cap"></i> å…­çˆ»å åœæ•™å­¸</h2>
                        <button x-show="tutorialSeen" class="panel-close" @click="activeModal = null"><i
                                class="fas fa-times"></i></button>
                    </div>
                    <div class="panel-content markdown-content">
                        <h3>ğŸ¯ ä»€éº¼æ˜¯å…­çˆ»ï¼Ÿ</h3>
                        <p>å…­çˆ»æ˜¯ä¸­åœ‹å¤è€çš„å åœæ–¹æ³•ï¼Œé€šéæ“²ä¸‰æšéŠ…éŒ¢å…­æ¬¡ï¼Œå½¢æˆå…­å€‹çˆ»ï¼Œçµ„æˆå¦è±¡ä¾†é æ¸¬å‰å‡¶ã€‚</p>

                        <h3>âœ… æ­£ç¢ºçš„å•å¦æ–¹å¼</h3>
                        <ul>
                            <li><strong>å•å…·é«”äº‹æƒ…</strong>ï¼šé€™æ¬¡æŠ•è³‡æœƒé †åˆ©å—ï¼Ÿ</li>
                            <li><strong>å•èµ°å‹¢è¶¨å‹¢</strong>ï¼šæœ€è¿‘ä¸‰å€‹æœˆçš„è²¡é‹å¦‚ä½•ï¼Ÿ</li>
                            <li><strong>å•ä¸€ä»¶äº‹</strong>ï¼šé€™ä»½å·¥ä½œé©åˆæˆ‘å—ï¼Ÿ</li>
                            <li><strong>å•æ–¹å‘å»ºè­°</strong>ï¼šå‘æ±é‚„æ˜¯å‘è¥¿ç™¼å±•æ›´å¥½ï¼Ÿ</li>
                        </ul>

                        <h3>âŒ éŒ¯èª¤çš„å•å¦æ–¹å¼</h3>
                        <ul>
                            <li><span style="color:var(--accent-red);">âœ˜</span> BTCä»€éº¼æ™‚å€™æœƒATHï¼Ÿï¼ˆå•å…·é«”æ™‚é–“é»ï¼‰</li>
                            <li><span style="color:var(--accent-red);">âœ˜</span> æˆ‘æœªä¾†æœƒä¸æœƒä¸­æ¨‚é€ï¼Ÿï¼ˆå•å¿…ç„¶äº‹ä»¶ï¼‰</li>
                            <li><span style="color:var(--accent-red);">âœ˜</span> æˆ‘æœƒæ´»åˆ°å¹¾æ­²ï¼Ÿï¼ˆå•å£½å‘½ï¼‰</li>
                            <li><span style="color:var(--accent-red);">âœ˜</span> åŒæ™‚å•å¤šä»¶äº‹æƒ…</li>
                        </ul>

                        <h3>ğŸ™ å•å¦å¿ƒæ³•</h3>
                        <p><strong>å¿ƒèª å‰‡éˆ</strong> - å åœä¹‹æ³•ï¼Œé¦–é‡å…¶èª ã€‚ç„¡äº‹ä¸å ï¼Œä¸å‹•ä¸å ã€‚</p>
                        <p><strong>ä¸€äº‹ä¸€å </strong> - ä¸€äº‹åªå¯ä¸€å ï¼Œåè¦†å•ä¹‹å‰‡ç‚ºè¤»ç€†ã€‚</p>

                        <div x-show="!tutorialSeen"
                            style="text-align:center; margin-top:30px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                            <p style="margin-bottom:15px; color:var(--primary-gold);">æ‚¨å·²é–±è®€ä¸¦äº†è§£å•å¦è¦å‰‡äº†å—ï¼Ÿ</p>
                            <button class="action-btn" @click="tutorialSeen = true; activeModal = null"
                                style="padding:10px 40px;">
                                æˆ‘å·²äº†è§£ï¼Œé–‹å§‹å•å¦
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Modal -->
            <div class="modal-layer" x-show="activeModal === 'settings'" @click.self="activeModal = null"
                x-transition.opacity>
                <div class="glass-panel" style="max-width:550px;">
                    <div class="panel-header">
                        <h2>ç³»çµ±è¨­å®š</h2>
                        <button class="panel-close" @click="activeModal = null"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="panel-content">
                        <h3 style="color:var(--primary-gold); margin-bottom:15px;"><i class="fas fa-user-circle"></i>
                            å¸³æˆ¶è¨­å®š</h3>
                        <div class="setting-item">
                            <label>ä¿®æ”¹å¯†ç¢¼</label>
                            <input type="password" x-model="newPassword" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ (è‡³å°‘6å­—)" class="auth-input"
                                style="margin-bottom:10px;">
                            <input type="password" x-model="confirmPassword" placeholder="ç¢ºèªæ–°å¯†ç¢¼" class="auth-input">
                            <button class="action-btn" style="margin-top:10px; padding:8px 20px;"
                                @click="changePassword()">æ›´æ–°å¯†ç¢¼</button>
                        </div>

                        <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:25px 0;">

                        <h3 style="color:var(--primary-gold); margin-bottom:15px;"><i class="fas fa-robot"></i> AI è¨­å®š
                        </h3>
                        <div class="setting-item">
                            <label>AI æ¨¡å‹ä¾†æº</label>
                            <select x-model="settings.ai_provider" class="elegant-select">
                                <option value="local">Local AI (æœ¬åœ°) - é è¨­</option>
                                <option value="gemini">Google Gemini (é›²ç«¯)</option>
                            </select>
                        </div>
                        <div x-show="settings.ai_provider === 'local'">
                            <div class="setting-item">
                                <label>Local API URL</label>
                                <input type="text" x-model="settings.local_api_url" class="auth-input">
                            </div>
                            <div class="setting-item">
                                <label>Model Name</label>
                                <input type="text" x-model="settings.local_model_name" class="auth-input">
                            </div>
                        </div>
                        <div x-show="settings.ai_provider === 'gemini'">
                            <div class="setting-item">
                                <label>Gemini API Key</label>
                                <input type="password" x-model="geminiApiKey" placeholder="è¼¸å…¥ä½ çš„ API Key"
                                    class="auth-input">
                                <button class="action-btn" style="margin-top:10px; padding:8px 20px;"
                                    @click="saveApiKey('gemini')">å„²å­˜ Key</button>
                            </div>
                        </div>

                        <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:25px 0;">

                        <div class="setting-item">
                            <label>æ¯æ—¥å¦æ•¸é™åˆ¶</label>
                            <select x-model="settings.daily_limit" class="elegant-select">
                                <option value="3">æ¯æ—¥ 3 å¦</option>
                                <option value="5">æ¯æ—¥ 5 å¦</option>
                                <option value="10">æ¯æ—¥ 10 å¦</option>
                                <option value="unlimited">ç„¡é™åˆ¶</option>
                            </select>
                        </div>

                        <div style="text-align:right; margin-top:20px;">
                            <button class="action-btn" @click="saveSettings()">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Modal -->
            <div class="modal-layer" x-show="activeModal === 'admin'" @click.self="activeModal = null"
                x-transition.opacity>
                <div class="glass-panel" style="max-width:800px;">
                    <div class="panel-header">
                        <h2><i class="fas fa-users-cog"></i> ç®¡ç†é¢æ¿</h2>
                        <button class="panel-close" @click="activeModal = null"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="panel-content">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3 style="color:var(--primary-gold); margin:0;">ç”¨æˆ¶åˆ—è¡¨</h3>
                            <button class="action-btn" style="padding:8px 15px;" @click="activeModal = 'register'"><i
                                    class="fas fa-user-plus"></i> æ–°å¢</button>
                        </div>
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="border-bottom:1px solid rgba(255,255,255,0.2);">
                                    <th style="text-align:left; padding:10px;">ID</th>
                                    <th style="text-align:left; padding:10px;">ç”¨æˆ¶å</th>
                                    <th style="text-align:left; padding:10px;">è§’è‰²</th>
                                    <th style="text-align:center; padding:10px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="user in allUsers" :key="user.id">
                                    <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                        <td style="padding:10px;" x-text="user.id"></td>
                                        <td style="padding:10px;" x-text="user.username"></td>
                                        <td style="padding:10px;"
                                            :style="user.role==='admin'?'color:var(--accent-red)':''"
                                            x-text="user.role"></td>
                                        <td style="padding:10px; text-align:center;">
                                            <button @click="deleteUser(user.id)" :disabled="user.id===1"
                                                style="background:none; border:none; color:var(--accent-red); cursor:pointer;"
                                                :style="user.id===1?'opacity:0.3':''"><i
                                                    class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Register Modal -->
            <div class="modal-layer" x-show="activeModal === 'register'" @click.self="activeModal = 'admin'"
                x-transition.opacity>
                <div class="glass-panel" style="max-width:400px;">
                    <div class="panel-header">
                        <h2><i class="fas fa-user-plus"></i> æ–°å¢ç”¨æˆ¶</h2>
                        <button class="panel-close" @click="activeModal = 'admin'"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="panel-content">
                        <form @submit.prevent="createUser()">
                            <div class="setting-item">
                                <label>ç”¨æˆ¶å</label>
                                <input type="text" x-model="registerForm.username" required class="auth-input">
                            </div>
                            <div class="setting-item">
                                <label>å¯†ç¢¼ (è‡³å°‘6å­—)</label>
                                <input type="password" x-model="registerForm.password" required minlength="6"
                                    class="auth-input">
                            </div>
                            <div class="setting-item">
                                <label>è§’è‰²</label>
                                <select x-model="registerForm.role" class="elegant-select">
                                    <option value="user">ä¸€èˆ¬ç”¨æˆ¶</option>
                                    <option value="admin">ç®¡ç†å“¡</option>
                                </select>
                            </div>
                            <div style="text-align:right; margin-top:20px;">
                                <button type="submit" class="action-btn">å‰µå»ºç”¨æˆ¶</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        function app() {
            return {
                activeModal: null,
                resultMode: false,
                tossingMode: false,
                currentCoins: [],
                question: '',
                lastQuestion: '',
                loading: false,
                result: '',
                parsedResult: '',
                structuredData: null,
                thinkContent: '',
                errorMessage: '',
                historyList: [],
                historyUserId: 'all',

                // Auth
                currentUser: null,
                loginForm: { username: '', password: '' },
                registerForm: { username: '', password: '', role: 'user' },
                authMode: 'login', // 'login' or 'register'
                newPassword: '',
                confirmPassword: '',
                geminiApiKey: '',
                tutorialSeen: false,

                // Admin
                allUsers: [],

                // Settings
                settings: {
                    daily_limit: '5',
                    ai_provider: 'local',
                    local_api_url: 'http://localhost:1234/v1',
                    local_model_name: 'qwen/qwen3-8b'
                },
                toolStatus: { get_divination_tool: 'unused', get_current_time: 'unused' },

                placeholderText: 'è«‹è¼¸å…¥æ‚¨å¿ƒä¸­çš„ç–‘æƒ‘...',
                phPhrases: ["è«‹è¼¸å…¥æ‚¨å¿ƒä¸­çš„ç–‘æƒ‘...", "æˆ‘æƒ³çŸ¥é“æˆ‘é€™é€±è²¡é‹å¦‚ä½•ï¼Ÿ", "é€™æ®µæ„Ÿæƒ…æœƒæœ‰çµæœå—ï¼Ÿ", "æœ€è¿‘å·¥ä½œä¸Šæœ‰ä»€éº¼è¦æ³¨æ„çš„ï¼Ÿ"],
                phIndex: 0, phCharIndex: 0, isDeleting: false,

                init() {
                    this.typeWriter();
                    this.checkAuth();
                },

                async checkAuth() {
                    try {
                        const res = await fetch('/api/current-user');
                        if (res.ok) {
                            this.currentUser = await res.json();
                            await this.checkFirstTimeUser();
                        } else {
                            this.activeModal = 'login';
                        }
                    } catch (e) {
                        this.activeModal = 'login';
                    }
                },

                async checkFirstTimeUser() {
                    if (!this.currentUser) return;
                    try {
                        const res = await fetch('/api/history');
                        if (res.ok) {
                            const history = await res.json();
                            if (history.length === 0) {
                                this.activeModal = 'tutorial';
                                this.tutorialSeen = false;
                            } else {
                                this.tutorialSeen = true;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to check history', e);
                    }
                },

                async register() {
                    try {
                        const res = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.registerForm)
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.currentUser = data.user;
                            this.activeModal = 'tutorial';
                            this.tutorialSeen = false;
                            this.registerForm = { username: '', password: '', role: 'user' };
                        } else {
                            const err = await res.json();
                            alert(err.error || 'è¨»å†Šå¤±æ•—');
                        }
                    } catch (e) {
                        alert('è¨»å†ŠéŒ¯èª¤');
                    }
                },

                async login() {
                    try {
                        const res = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.currentUser = data.user;
                            this.activeModal = null;
                            this.loginForm = { username: '', password: '' };
                            await this.checkFirstTimeUser();
                        } else {
                            const err = await res.json();
                            alert(err.error || 'ç™»å…¥å¤±æ•—');
                        }
                    } catch (e) {
                        alert('ç™»å…¥éŒ¯èª¤');
                    }
                },

                async logout() {
                    await fetch('/api/logout', { method: 'POST' });
                    this.currentUser = null;
                    this.activeModal = 'login';
                },

                typeWriter() {
                    const phrase = this.phPhrases[this.phIndex];
                    if (this.isDeleting) {
                        this.placeholderText = phrase.substring(0, this.phCharIndex - 1);
                        this.phCharIndex--;
                    } else {
                        this.placeholderText = phrase.substring(0, this.phCharIndex + 1);
                        this.phCharIndex++;
                    }
                    let speed = this.isDeleting ? 50 : 100;
                    if (!this.isDeleting && this.phCharIndex === phrase.length) {
                        speed = 2000; this.isDeleting = true;
                    } else if (this.isDeleting && this.phCharIndex === 0) {
                        this.isDeleting = false;
                        this.phIndex = (this.phIndex + 1) % this.phPhrases.length;
                        speed = 500;
                    }
                    setTimeout(() => this.typeWriter(), speed);
                },

                goHome() {
                    this.resultMode = false;
                    this.activeModal = null;
                    this.errorMessage = '';
                },

                getCoinLabel(c) { return { 0: 'è€é™°', 1: 'é™½', 2: 'é™°', 3: 'è€é™½' }[c] || '?'; },
                getCoinClass(c) { return ['coin-old-yin', 'coin-yang', 'coin-yin', 'coin-old-yang'][c] || ''; },

                processResult(rawText) {
                    this.thinkContent = '';
                    this.structuredData = null;
                    this.parsedResult = '';
                    let cleanText = rawText;

                    // 1. Extract <think> content
                    const thinkMatch = rawText.match(/<think>([\s\S]*?)<\/think>/);
                    if (thinkMatch) {
                        this.thinkContent = thinkMatch[1].trim();
                        cleanText = rawText.replace(/<think>[\s\S]*?<\/think>/, '').trim();
                    }

                    // 2. Try to parse JSON from remaining text
                    // We look for any JSON-like structure, possibly inside markdown blocks
                    try {
                        let potentialJson = cleanText;

                        // Handle markdown code blocks (```json ... ```)
                        const codeBlockMatch = cleanText.match(/```(?:json)?\s*([\s\S]*?)```/i);
                        if (codeBlockMatch) {
                            potentialJson = codeBlockMatch[1].trim();
                        }

                        // Extract content between first { and last }
                        const firstBrace = potentialJson.indexOf('{');
                        const lastBrace = potentialJson.lastIndexOf('}');

                        if (firstBrace !== -1 && lastBrace !== -1) {
                            const jsonStr = potentialJson.substring(firstBrace, lastBrace + 1);
                            const parsed = JSON.parse(jsonStr);

                            // Validate essential fields
                            if (parsed.summary && parsed.overview && parsed.sections && Array.isArray(parsed.sections)) {
                                this.structuredData = parsed;
                                return;
                            }
                        }
                    } catch (e) {
                        console.warn("Structured JSON parsing failed, falling back to markdown", e);
                    }

                    // 3. Fallback: If JSON parsing fails or schema is invalid, render as Markdown
                    this.parsedResult = marked.parse(cleanText);
                },

                async performDivination() {
                    if (!this.question.trim()) { this.errorMessage = "è«‹è¼¸å…¥å•é¡Œ"; return; }
                    this.tossingMode = true;
                    this.currentCoins = [];
                    this.loading = true;
                    this.errorMessage = '';
                    this.lastQuestion = this.question;

                    for (let i = 0; i < 6; i++) {
                        await new Promise(r => setTimeout(r, 300));
                        this.currentCoins.push(Math.floor(Math.random() * 4));
                    }
                    await new Promise(r => setTimeout(r, 1000));

                    try {
                        const res = await fetch('/api/divinate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ question: this.question, coins: this.currentCoins })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'è«‹æ±‚å¤±æ•—');

                        this.tossingMode = false;
                        this.result = data.result;
                        this.processResult(data.result);
                        this.toolStatus = data.tool_status || {};
                        this.resultMode = true;
                    } catch (e) {
                        this.tossingMode = false;
                        this.errorMessage = e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                randomQuestion() {
                    const qs = ["æ­¤è¡Œé‹å‹¢å¦‚ä½•ï¼Ÿ", "è¿‘æœŸè²¡é‹èµ°å‹¢", "å¿ƒä¸­æ‰€æƒ³ä¹‹äº‹å¯æˆå¦ï¼Ÿ", "å·¥ä½œè®Šå‹•ä¹‹å‰å‡¶"];
                    this.question = qs[Math.floor(Math.random() * qs.length)];
                },

                showResult(item) {
                    this.lastQuestion = item.question || '';
                    this.result = item.interpretation;
                    this.processResult(item.interpretation);
                    this.resultMode = true;
                },

                copyResult() {
                    const text = `å•é¡Œï¼š${this.lastQuestion}\n\n${this.result}`;
                    navigator.clipboard.writeText(text);
                    alert('å·²è¤‡è£½');
                },

                async fetchHistory() {
                    let url = '/api/history';
                    if (this.currentUser && this.currentUser.role === 'admin' && this.historyUserId) {
                        url += `?user_id=${this.historyUserId}`;
                    }
                    const res = await fetch(url);
                    if (res.ok) this.historyList = await res.json();
                },

                async toggleFavorite(item) {
                    item.is_favorite = !item.is_favorite;
                    await fetch(`/api/history/${item.id}/favorite`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_favorite: item.is_favorite })
                    });
                },

                async deleteHistory(item) {
                    if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
                    await fetch(`/api/history/${item.id}`, { method: 'DELETE' });
                    this.historyList = this.historyList.filter(h => h.id !== item.id);
                },

                async fetchSettings() {
                    const res = await fetch('/api/settings');
                    if (res.ok) {
                        const data = await res.json();
                        Object.assign(this.settings, data);
                    }
                },

                async saveSettings() {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.settings)
                    });
                    alert("è¨­å®šå·²å„²å­˜");
                    this.activeModal = null;
                },

                async changePassword() {
                    if (!this.newPassword || this.newPassword.length < 6) {
                        alert("å¯†ç¢¼è‡³å°‘6å€‹å­—ç¬¦"); return;
                    }
                    if (this.newPassword !== this.confirmPassword) {
                        alert("å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´"); return;
                    }
                    const res = await fetch('/api/user/password', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ new_password: this.newPassword })
                    });
                    if (res.ok) {
                        alert("å¯†ç¢¼å·²æ›´æ–°");
                        this.newPassword = '';
                        this.confirmPassword = '';
                    } else {
                        alert("æ›´æ–°å¤±æ•—");
                    }
                },

                async saveApiKey(provider) {
                    const key = provider === 'gemini' ? this.geminiApiKey : '';
                    await fetch('/api/user/api-keys', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ provider, api_key: key })
                    });
                    alert("API Key å·²å„²å­˜");
                },

                async fetchUsers() {
                    const res = await fetch('/api/admin/users');
                    if (res.ok) this.allUsers = await res.json();
                },

                async createUser() {
                    const res = await fetch('/api/admin/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.registerForm)
                    });
                    if (res.ok) {
                        alert("ç”¨æˆ¶å·²å‰µå»º");
                        this.registerForm = { username: '', password: '', role: 'user' };
                        this.fetchUsers();
                        this.activeModal = 'admin';
                    } else {
                        const err = await res.json();
                        alert(err.error || "å‰µå»ºå¤±æ•—");
                    }
                },

                async deleteUser(userId) {
                    if (!confirm("ç¢ºå®šåˆªé™¤æ­¤ç”¨æˆ¶ï¼Ÿ")) return;
                    const res = await fetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
                    if (res.ok) {
                        this.allUsers = this.allUsers.filter(u => u.id !== userId);
                    }
                }
            }
        }
    </script>
</body>

</html>