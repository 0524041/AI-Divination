<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>靈機一動 - 易經占卜</title>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;700&family=Zen+Maru+Gothic:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div x-data="app()">
        <!-- Background Orbs -->
        <div class="bg-orb orb-1"></div>
        <div class="bg-orb orb-2"></div>

        <!-- Header -->
        <header>
            <div class="brand" @click="goHome()">
                <i class="fas fa-yin-yang fa-spin" style="animation-duration: 10s;"></i> 靈機一動
            </div>
            <nav class="nav-menu">
                <div class="nav-item" @click="fetchHistory(); activeModal = 'history'">
                    <i class="fas fa-history"></i> <span>歷史紀錄</span>
                </div>
                <div class="nav-item" @click="activeModal = 'intro'">
                    <i class="fas fa-book-open"></i> <span>算卦規則</span>
                </div>
                <div class="nav-item" @click="fetchSettings(); activeModal = 'settings'">
                    <i class="fas fa-cog"></i> <span>設定</span>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <div class="content-wrapper" x-show="!resultMode">
                <div class="divine-container">
                    <h1 class="main-title">誠心占卜</h1>
                    <p class="sub-title">天機不可洩露，唯誠者可得之</p>

                    <div class="input-card">
                        <textarea class="elegant-input" x-model="question" :placeholder="placeholderText"
                            @input="$el.style.height = ''; $el.style.height = Math.min($el.scrollHeight, 200) + 'px'"></textarea>
                    </div>

                    <button class="action-btn" @click="performDivination()" :disabled="loading">
                        <template x-if="!loading">
                            <span>開始起卦</span>
                        </template>
                        <template x-if="loading">
                            <span><i class="fas fa-circle-notch fa-spin"></i> 演算中</span>
                        </template>
                    </button>

                    <div style="margin-top:20px;">
                        <span @click="randomQuestion()"
                            style="color:var(--text-muted); font-size:0.9rem; cursor:pointer; border-bottom:1px dashed var(--text-muted);">
                            不知問什麼？試試靈感
                        </span>
                    </div>
                    <p x-show="errorMessage" x-text="errorMessage"
                        style="color: #c0392b; margin-top: 20px; font-weight: bold;"></p>
                </div>
            </div>

            <!-- Result View / Modal-like Overlay -->
            <div class="modal-layer" x-show="resultMode" x-transition.opacity>
                <div class="glass-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-star" style="font-size:0.8em; margin-right:8px;"></i> 卦象解析</h2>
                        <div style="flex-grow:1;"></div>
                        <!-- Status Indicators -->
                        <div class="status-indicator" title="六爻工具狀態">
                            <div class="status-dot"
                                :class="toolStatus.get_divination_tool == 'success' ? 'success' : (toolStatus.get_divination_tool == 'error' ? 'error' : '')">
                            </div>
                            <span>排盤</span>
                        </div>
                        <div class="status-indicator" title="時間工具狀態">
                            <div class="status-dot"
                                :class="toolStatus.get_current_time == 'success' ? 'success' : (toolStatus.get_current_time == 'error' ? 'error' : '')">
                            </div>
                            <span>天時</span>
                        </div>
                        <button class="panel-close" @click="resultMode = false; goHome()"><i
                                class="fas fa-times"></i></button>
                    </div>
                    <div class="panel-content markdown-content" x-html="parsedResult"></div>
                    <div style="padding:20px 30px; text-align:right; border-top:1px solid rgba(255,255,255,0.05);">
                        <button class="action-btn" style="padding: 8px 24px; font-size:1rem;"
                            @click="copyResult()">複製結果</button>
                    </div>
                </div>
            </div>

            <!-- History Modal -->
            <div class="modal-layer" x-show="activeModal === 'history'" @click.self="activeModal = null"
                x-transition.opacity>
                <div class="glass-panel">
                    <div class="panel-header">
                        <h2>過往紀錄</h2>
                        <button class="panel-close" @click="activeModal = null"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="panel-content" style="padding:0;">
                        <div x-show="historyList.length === 0"
                            style="padding:40px; text-align:center; color:var(--text-muted);">
                            暫無歷史紀錄
                        </div>
                        <template x-for="item in historyList" :key="item.id">
                            <div class="history-row">
                                <div @click="showResult(item); activeModal = null" style="flex-grow:1;">
                                    <div style="color:var(--text-main); font-size:1.1rem; margin-bottom:4px;"
                                        x-text="item.question"></div>
                                    <div class="row-date" x-text="item.created_at"></div>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button @click="toggleFavorite(item)"
                                        style="background:none; border:none; cursor:pointer; font-size:1.2rem;">
                                        <i :class="item.is_favorite ? 'fas fa-heart' : 'far fa-heart'"
                                            :style="item.is_favorite ? 'color: #c0392b' : 'color:var(--text-muted)'"></i>
                                    </button>
                                    <button @click="deleteHistory(item)"
                                        style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--text-muted);">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Intro Modal -->
            <div class="modal-layer" x-show="activeModal === 'intro'" @click.self="activeModal = null"
                x-transition.opacity>
                <div class="glass-panel">
                    <div class="panel-header">
                        <h2>六爻占卜</h2>
                        <button class="panel-close" @click="activeModal = null"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="panel-content markdown-content">
                        <p><strong>心誠則靈</strong><br>占卜之法，首重其誠。無事不占，不動不占。心中有疑，方可問天。</p>
                        <p><strong>一事一占</strong><br>凡欲問卜，一事只可一占。若心存疑慮，反覆問之，則為褻瀆，其卦必不驗。</p>
                        <p><strong>外應之說</strong><br>除起卦之外，若見奇異徵兆，或靈機一動，皆可為占卜之機，此即梅花易數之理。</p>
                    </div>
                </div>
            </div>

            <!-- Tossing Modal -->
            <div class="modal-layer" x-show="tossingMode" style="background: rgba(0,0,0,0.85);" x-transition.opacity>
                <div class="glass-panel" style="text-align:center; max-width:400px;">
                    <h2 class="animate-pulse" style="margin-bottom:20px; color:var(--accent-gold);">
                        <i class="fas fa-dice-d6 fa-spin"></i> 誠心搖卦中...
                    </h2>

                    <div class="coins-container"
                        style="display:flex; flex-direction:column-reverse; gap:10px; margin:20px 0; align-items:center;">
                        <template x-for="(coin, index) in currentCoins" :key="index">
                            <div class="coin-row" x-show="true" x-transition:enter="transition ease-out duration-300"
                                x-transition:enter-start="opacity-0 transform scale-90"
                                x-transition:enter-end="opacity-100 transform scale-100">
                                <span style="font-size:0.8rem; color:var(--text-muted); margin-right:10px;"
                                    x-text="'第 ' + (index+1) + ' 爻'"></span>
                                <div class="coin-visual" :class="coin === 1 ? 'coin-yang' : 'coin-yin'">
                                    <span x-text="coin === 1 ? '陽' : '陰'"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div x-show="currentCoins.length === 6" style="margin-top:20px;">
                        <p class="fade-in">卦象已定，正在解盤...</p>
                    </div>
                </div>
            </div>

            <!-- Settings Modal -->
            <div class="modal-layer" x-show="activeModal === 'settings'" @click.self="activeModal = null"
                x-transition.opacity>
                <div class="glass-panel" style="max-width:500px;">
                    <div class="panel-header">
                        <h2>系統設定</h2>
                        <button class="panel-close" @click="activeModal = null"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="panel-content">
                        <div class="setting-item">
                            <label>每日卦數限制</label>
                            <select x-model="settings.daily_limit" class="elegant-select" @change="saveSettings()">
                                <option value="1">每日 1 卦</option>
                                <option value="3">每日 3 卦</option>
                                <option value="5">每日 5 卦 (預設)</option>
                                <option value="10">每日 10 卦</option>
                                <option value="unlimited">誠心無上限</option>
                            </select>
                            <p style="font-size:0.9rem; color:var(--text-muted); margin-top:8px;">設定限制有助於保持占卜的嚴肅性。</p>
                        </div>

                        <div class="setting-item">
                            <label>AI 模型來源</label>
                            <select x-model="settings.ai_provider" class="elegant-select" @change="saveSettings()">
                                <option value="gemini">Google Gemini (雲端)</option>
                                <option value="local">Local AI (本地) - OpenAI 兼容</option>
                            </select>
                        </div>

                        <div x-show="settings.ai_provider === 'local'" x-transition.opacity>
                            <div class="setting-item">
                                <label>Local API URL (e.g., http://localhost:1234/v1)</label>
                                <input type="text" class="elegant-input" x-model="settings.local_api_url"
                                    style="width:100%; padding:8px; background:rgba(255,255,255,0.05); color:white; border:1px solid rgba(255,255,255,0.2); border-radius:5px;">
                            </div>
                            <div class="setting-item">
                                <label>Model Name (e.g., qwen/qwen3-8b)</label>
                                <input type="text" class="elegant-input" x-model="settings.local_model_name"
                                    style="width:100%; padding:8px; background:rgba(255,255,255,0.05); color:white; border:1px solid rgba(255,255,255,0.2); border-radius:5px;">
                            </div>
                        </div>


                        <div style="text-align:right; margin-top:10px;">
                            <button class="action-btn" style="padding: 8px 20px; font-size:0.9rem;"
                                @click="saveSettings()">儲存設定</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        function app() {
            return {
                activeModal: null,
                resultMode: false,
                tossingMode: false,
                currentCoins: [],
                question: '',
                loading: false,
                result: '',
                parsedResult: '',
                errorMessage: '',
                historyList: [],
                settings: {
                    daily_limit: '5',
                    ai_provider: 'gemini',
                    local_api_url: 'http://localhost:1234/v1',
                    local_model_name: 'qwen/qwen3-8b'
                },
                toolStatus: { get_divination_tool: 'unused', get_current_time: 'unused' },

                // Typewriter Placeholder
                placeholderText: '',
                phPhrases: [
                    "請在此輸入您心中的疑惑...",
                    "我想知道我這週財運如何？",
                    "這段感情會有結果嗎？",
                    "最近工作上有什麼要注意的？",
                    "心誠則靈，請輸入您的問題..."
                ],
                phIndex: 0,
                phCharIndex: 0,
                isDeleting: false,

                init() {
                    this.typeWriter();
                },

                typeWriter() {
                    const currentPhrase = this.phPhrases[this.phIndex];

                    if (this.isDeleting) {
                        this.placeholderText = currentPhrase.substring(0, this.phCharIndex - 1);
                        this.phCharIndex--;
                    } else {
                        this.placeholderText = currentPhrase.substring(0, this.phCharIndex + 1);
                        this.phCharIndex++;
                    }

                    let typeSpeed = 100;

                    if (this.isDeleting) {
                        typeSpeed /= 2; // Faster deletion
                    }

                    if (!this.isDeleting && this.phCharIndex === currentPhrase.length) {
                        typeSpeed = 2000; // Pause at end
                        this.isDeleting = true;
                    } else if (this.isDeleting && this.phCharIndex === 0) {
                        this.isDeleting = false;
                        this.phIndex = (this.phIndex + 1) % this.phPhrases.length;
                        typeSpeed = 500;
                    }

                    setTimeout(() => this.typeWriter(), typeSpeed);
                },

                goHome() {
                    this.resultMode = false;
                    this.activeModal = null;
                    this.errorMessage = '';
                },

                async performDivination() {
                    if (!this.question.trim()) {
                        this.errorMessage = "請輸入您心中的疑惑";
                        return;
                    }

                    // Start tossing animation
                    this.tossingMode = true;
                    this.currentCoins = [];
                    this.loading = true;
                    this.errorMessage = '';

                    // Generate 6 coins (each 0-3, representing number of tails in 3 coin tosses)
                    // 顯示每一爻的生成過程
                    for (let i = 0; i < 6; i++) {
                        await new Promise(resolve => setTimeout(resolve, 300)); // 每爻間隔300ms
                        const coinValue = Math.floor(Math.random() * 4); // 0, 1, 2, or 3
                        this.currentCoins.push(coinValue);
                    }

                    // 卦象已定，等待1秒後發送請求
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    try {
                        const response = await fetch('/api/divinate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                question: this.question,
                                coins: this.currentCoins
                            })
                        });
                        const data = await response.json();

                        if (!response.ok) {
                            if (response.status === 403) {
                                throw new Error("今日卦數已達上限，請明日請早。");
                            } else if (response.status === 429) {
                                throw new Error("天機繁忙，請稍候片刻再試 (API 限流)。");
                            } else {
                                throw new Error(data.error || '天機未現，請稍後再試');
                            }
                        }

                        // 關閉搖卦畫面
                        this.tossingMode = false;

                        this.result = data.result;
                        this.parsedResult = marked.parse(data.result);
                        this.toolStatus = data.tool_status || { get_divination_tool: 'unused', get_current_time: 'unused' };
                        this.resultMode = true;
                    } catch (e) {
                        this.tossingMode = false;
                        this.errorMessage = e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                randomQuestion() {
                    const samples = ["此行運勢如何？", "近期財運走勢", "心中所想之事可成否？", "工作變動之吉凶"];
                    this.question = samples[Math.floor(Math.random() * samples.length)];
                },

                showResult(item) {
                    this.result = item.interpretation;
                    this.parsedResult = marked.parse(this.result);
                    this.resultMode = true;
                },

                copyResult() {
                    navigator.clipboard.writeText(this.result);
                    alert('已複製卦象');
                },

                async fetchHistory() {
                    const res = await fetch('/api/history');
                    this.historyList = await res.json();
                },

                async toggleFavorite(item) {
                    item.is_favorite = !item.is_favorite;
                    await fetch(`/api/history/${item.id}/favorite`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_favorite: item.is_favorite })
                    });
                },

                async deleteHistory(item) {
                    if (!confirm("確定要刪除這條紀錄嗎？此操作無法復原。")) return;

                    try {
                        await fetch(`/api/history/${item.id}`, { method: 'DELETE' });
                        // Remove from local list
                        this.historyList = this.historyList.filter(h => h.id !== item.id);
                    } catch (e) {
                        alert("刪除失敗");
                    }
                },

                async fetchSettings() {
                    const res = await fetch('/api/settings');
                    const data = await res.json();
                    this.settings.daily_limit = data.daily_limit;
                    this.settings.system_prompt = data.system_prompt;
                    this.defaultPrompt = data.default_prompt;
                    this.settings.ai_provider = data.ai_provider || 'gemini';
                    this.settings.local_api_url = data.local_api_url || 'http://localhost:1234/v1';
                    this.settings.local_model_name = data.local_model_name || 'qwen/qwen3-8b';
                },

                async saveSettings() {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.settings)
                    });
                    alert("設定已儲存");
                    this.activeModal = null;
                },

                restoreDefaultPrompt() {
                    if (confirm("確定要恢復預設的 AI 指令嗎？")) {
                        this.settings.system_prompt = this.defaultPrompt;
                    }
                }
            }
        }
    </script>
</body>

</html>