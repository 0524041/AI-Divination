# Zi Wei Dou Shu Data Flow & Prompt Schema

本文檔說明紫微斗數功能的前後端資料流、資料結構定義，以及最終送給 AI 的 Prompt 格式。

---

## 1. Frontend to Backend (POST /api/ziwei)

前端負責收集用戶輸入、計算本命盤 (Chart)，並將所有資訊發送至後端。
**注意：所有日期均為「陽曆 (Solar Date)」格式。**

### Request Schema

```json
{
  "birth_data_id": null,               // (Optional) 若從已存用戶選擇，否則 null
  "name": "陳小明",                     // 測算者姓名
  "gender": "男",                       // 性別：男/女
  "birth_date": "1990-06-15T10:30:00Z", // 出生日期 (陽曆 ISO 8601)
  "birth_location": "台北市",            // 出生地點 (用於真太陽時校正，前端已處理完校正，此為紀錄用)
  "is_twin": false,                    // 是否雙胞胎
  "twin_order": null,                  // 雙胞胎順序 (1:老大, 2:老二...)
  
  "query_type": "yearly",              // 測算類型：natal (本命), yearly (流年), monthly (流月), daily (流日)
  "query_date": "2025-02-10T00:00:00Z",// 測算日期 (陽曆 ISO 8601)。流年/流月/流日必填
  "question": "請問今年的事業運勢如何？是否適合轉職？", // 用戶問題

  "chart_data": {                      // 完整 iztro 命盤物件 (前端計算結果)
    "solarDate": "1990-06-15",
    "lunarDate": "一九九零年五月廿三",
    "chineseDate": "庚午 壬午 戊申 丁巳", // 四柱 (年 月 日 時)
    "time": "巳時",
    "fiveElementsClass": "火六局",
    "palaces": [
      {
        "index": 0,
        "name": "命宮",
        "isBodyPalace": false,
        "heavenlyStem": "戊",
        "earthlyBranch": "申",
        "majorStars": [
          { "name": "貪狼", "brightness": "旺", "mutagen": "祿" }
        ],
        "minorStars": [...],
        "decadal": { "range": [6, 15] }, // 大限區間
        "ages": [6, 18, 30, ...]         // 小限歲數
      },
      // ... 其餘 11 宮
    ],
    "correctionNote": "經真太陽時校正：時辰由【辰】變更為【巳】" // 前端注入的校正資訊
  },
  
  "prompt_context": null               // (Legacy) 舊欄位，後端重構後已忽略此欄位，改由後端動態生成
}
```

---

## 2. Backend Processing (ZiweiService)

後端收到請求後，`ZiweiService` 會執行以下邏輯：
1.  **計算虛歲**：根據 `birth_date` 與 `query_date` 計算當下虛歲。
2.  **定位流運**：
    *   **大限命宮**：比對虛歲落在 `chart_data` 中哪個宮位的 `decadal.range`。
    *   **流年命宮**：根據 `query_date` 的年份地支（如 2025 乙巳年 -> 巳），定位對應的地支宮位。
3.  **資料重組**：將複雜的 JSON 簡化為 AI 易讀的 Markdown/JSON 混合格式。

---

## 3. Final AI Prompt Structure

後端處理完畢後，會將資料注入 `backend/prompts/ziwei_system.md` 模板。
以下是最終送給 LLM 的完整 Prompt 範例：

### System Prompt Example

```markdown
# Role
你是一位精通紫微斗數的命理大師... (略)

---

# 核心任務
請根據以下的【使用者資訊】、【完整命盤】與【補充說明】，為使用者進行詳盡的紫微斗數解盤。

## 1. 使用者資訊
{
  "姓名": "陳小明",
  "性別": "男",
  "虛歲": 36,
  "測算類型": "yearly",
  "測算時間": "2025-02-10",
  "問題": "請問今年的事業運勢如何？是否適合轉職？",
  "備註": "一般"
}

## 2. 完整命盤
{
  "局數": "火六局",
  "生肖": "馬",
  "十二宮詳情": [
    {
      "宮位": "命宮",
      "地支": "申",
      "天干": "戊",
      "主星": ["貪狼(旺)[祿]"],
      "副星": ["火星", "天馬"],
      "雜曜": ["孤辰"],
      "大限": "6-15",
      "標記": ["本命命宮"]
    },
    {
      "宮位": "父母",
      "地支": "酉",
      "天干": "己",
      "主星": ["太陰(旺)", "天同(平)"],
      "副星": [],
      "雜曜": [],
      "大限": "16-25",
      "標記": []
    },
    // ... (省略中間宮位)
    {
      "宮位": "子女",
      "地支": "巳",
      "天干": "丁",
      "主星": ["廉貞(廟)", "破軍(陷)"],
      "副星": ["擎羊"],
      "雜曜": [],
      "大限": "36-45",
      "小限": [36, 48, 60],
      "標記": ["大限命宮", "流年命宮", "小限命宮"]  <--- 後端自動標記了流運宮位
    }
  ]
}

## 3. 補充說明
{
  "當前狀態": "虛歲 36 歲，流年地支為 巳",
  "大限命宮": "子女宮 (地支巳)",
  "流年命宮": "子女宮 (地支巳)",
  "小限命宮": "子女宮 (地支巳)",
  "解盤重點": "請重點分析本命盤性格，並結合大限、小限與流年運勢回答用戶問題。"
}

---

# 解盤邏輯流程 (SOP)
(略...包含安全檢核、四化分析引導等)
```

### User Prompt

```text
請解答我的問題：請問今年的事業運勢如何？是否適合轉職？
```

---

## 4. Key Logic Notes

1.  **日期統一**：前端與後端溝通一律使用 **ISO 8601 陽曆**。
2.  **虛歲算法**：後端目前採用 `查詢年 - 出生年 + 1` 的通用虛歲算法。
3.  **流年定位**：後端直接使用 `query_date` 的年份地支去匹配 `chart_data` 中的 `earthlyBranch`，不依賴前端傳送的流年盤結構。這確保了「本命盤」是唯一的 Truth Source。
4.  **對宮法**：若 `is_twin=true` 且 `twin_order="2"`，後端會在「補充說明」中標註「雙胞胎老二 (已套用對宮法)」，提示 AI 在解讀時需注意。
