# ğŸ“Š è³‡æ–™åº«ç®¡ç†æŒ‡å—

## å¿«é€Ÿå‘½ä»¤

```bash
# å„ªåŒ–è³‡æ–™åº«ï¼ˆæ¨è–¦å®šæœŸåŸ·è¡Œï¼‰
./start.sh --optimize-db

# æŸ¥çœ‹è³‡æ–™åº«çµ±è¨ˆ
cd backend && python3 optimize_db_simple.py stats

# æ¸¬è©¦æ€§èƒ½
cd backend && python3 optimize_db_simple.py test

# æ¸…ç†ç¢ç‰‡ï¼ˆè³‡æ–™åº« >10MB æ™‚ï¼‰
cd backend && python3 optimize_db_simple.py vacuum
```

---

## è³‡æ–™åº«å„ªåŒ–å·¥å…·èªªæ˜

### å…©å€‹å„ªåŒ–è…³æœ¬çš„å·®ç•°

| åŠŸèƒ½ | optimize_db_simple.py | optimize_db.py |
|------|---------------------|----------------|
| ä¾è³´ | âœ… ç„¡ï¼ˆç´” sqlite3ï¼‰ | âŒ éœ€è¦ SQLAlchemy |
| ç©©å®šæ€§ | âœ… é«˜ | âš ï¸ ç’°å¢ƒç›¸ä¾ |
| åŠŸèƒ½ | âœ… å®Œæ•´ | âœ… å®Œæ•´ |
| **æ¨è–¦** | âœ… **ä½¿ç”¨é€™å€‹** | âŒ ä¸æ¨è–¦ |

**çµè«–**ï¼šçµ±ä¸€ä½¿ç”¨ `optimize_db_simple.py`

---

## SQLite æ€§èƒ½åˆ†æ

### ä½ çš„ä½¿ç”¨æƒ…å¢ƒ

**é ä¼°è¦æ¨¡**ï¼š
- ç”¨æˆ¶æ•¸ï¼š1,000 äºº
- æ¯äººæ­·å²è¨˜éŒ„ï¼š100 ç­†
- **ç¸½è¨˜éŒ„æ•¸ï¼š100,000 ç­†**

### SQLite èƒ½åŠ›è©•ä¼°

| é …ç›® | SQLite æ¥µé™ | ä½ çš„è¦æ¨¡ | è©•ä¼° |
|------|------------|---------|------|
| è¨˜éŒ„æ•¸ | æ•¸ç™¾è¬åˆ°æ•¸åƒè¬ | 100,000 | âœ… è¼•é¬† |
| è³‡æ–™åº«å¤§å° | > 1TB | < 100MB | âœ… æ¥µå° |
| ä¸¦ç™¼è®€å– | ç„¡é™åˆ¶ | ä¸­ç­‰ | âœ… è¶³å¤  |
| ä¸¦ç™¼å¯«å…¥ | 1 å€‹ | ä¸­ç­‰ | âš ï¸ å¯èƒ½æˆç‚ºç“¶é ¸ |

**çµè«–**ï¼šâœ… **SQLite å®Œå…¨è¶³å¤ ï¼**

---

## æ€§èƒ½æ¸¬è©¦çµæœ

### ç•¶å‰æ€§èƒ½ï¼ˆå·²å„ªåŒ–ï¼‰

åŸºæ–¼ä½ çš„è³‡æ–™åº«æ¸¬è©¦çµæœï¼š

```
æª”æ¡ˆå¤§å°: 160 KB
ç”¨æˆ¶æ•¸: 2
æ­·å²è¨˜éŒ„: 14

æŸ¥è©¢æ€§èƒ½ï¼š
  ç°¡å–®æŸ¥è©¢: 0.09ms    âœ… å„ªç§€
  æ’åºæŸ¥è©¢: 0.42ms    âœ… å„ªç§€
  è¯çµæŸ¥è©¢: 0.18ms    âœ… å„ªç§€
```

### é ä¼° 1000 ç”¨æˆ¶æ€§èƒ½

åŸºæ–¼ç´¢å¼•å„ªåŒ–å¾Œçš„æ€§èƒ½é ä¼°ï¼š

| æ“ä½œ | é ä¼°æ™‚é–“ | èªªæ˜ |
|------|---------|------|
| æŸ¥è©¢å–®ä¸€ç”¨æˆ¶æ­·å²ï¼ˆ20ç­†ï¼‰ | < 5ms | æœ‰ user_id ç´¢å¼• |
| æŒ‰æ™‚é–“æ’åºï¼ˆ20ç­†ï¼‰ | < 10ms | æœ‰ created_at ç´¢å¼• |
| æœå°‹ç‰¹å®šé¡å‹ | < 15ms | æœ‰ divination_type ç´¢å¼• |
| ç™»å…¥é©—è­‰ | < 2ms | æœ‰ username ç´¢å¼• |

**çµè«–**ï¼šå³ä½¿åœ¨ 1000 ç”¨æˆ¶è¦æ¨¡ä¸‹ï¼ŒæŸ¥è©¢é€Ÿåº¦ä¾ç„¶æ¥µå¿«ï¼ˆ< 20msï¼‰

---

## ä½•æ™‚éœ€è¦å‡ç´šåˆ° PostgreSQL/MySQLï¼Ÿ

### ç¹¼çºŒä½¿ç”¨ SQLite çš„æ¢ä»¶ âœ…

- âœ… ç”¨æˆ¶æ•¸ < 10,000
- âœ… ç¸½è¨˜éŒ„æ•¸ < 1,000,000
- âœ… å–®ä¼ºæœå™¨éƒ¨ç½²
- âœ… è®€å¤šå¯«å°‘
- âœ… ä¸éœ€è¦è¤‡é›œçš„å…¨æ–‡æª¢ç´¢
- âœ… ä¸éœ€è¦åœ°ç†ç©ºé–“æŸ¥è©¢

**ä½ çš„æƒ…æ³**ï¼šå®Œå…¨ç¬¦åˆï¼Œç¹¼çºŒç”¨ SQLiteï¼

### éœ€è¦å‡ç´šçš„ä¿¡è™Ÿ ğŸš¨

ç•¶å‡ºç¾ä»¥ä¸‹æƒ…æ³æ™‚è€ƒæ…®å‡ç´šï¼š

1. **å¯«å…¥è®Šæ…¢**
   - æ’å…¥/æ›´æ–°æ“ä½œ > 100ms
   - å‡ºç¾ "database is locked" éŒ¯èª¤

2. **æª”æ¡ˆéå¤§**
   - è³‡æ–™åº«æª”æ¡ˆ > 10GB
   - VACUUM åŸ·è¡Œæ™‚é–“ > 5 åˆ†é˜

3. **éœ€è¦é€²éšåŠŸèƒ½**
   - å…¨æ–‡æª¢ç´¢ï¼ˆé›–ç„¶ SQLite ä¹Ÿæ”¯æ´ FTS5ï¼‰
   - è¤‡é›œçš„åœ°ç†ç©ºé–“æŸ¥è©¢
   - JSON æ¬„ä½æŸ¥è©¢ï¼ˆPostgreSQL JSONBï¼‰

4. **éƒ¨ç½²éœ€æ±‚**
   - éœ€è¦å¤šä¼ºæœå™¨éƒ¨ç½²
   - éœ€è¦è®€å¯«åˆ†é›¢
   - éœ€è¦ä¸»å¾è¤‡è£½

---

## ä¸Šç·šç’°å¢ƒè³‡æ–™åº«ç®¡ç†

### é¦–æ¬¡éƒ¨ç½²æ™‚

```bash
# 1. å•Ÿå‹•æœå‹™ï¼ˆæœƒè‡ªå‹•å‰µå»ºè³‡æ–™åº«ï¼‰
./start.sh

# 2. å„ªåŒ–è³‡æ–™åº«ï¼ˆå‰µå»ºç´¢å¼•ï¼‰
./start.sh --optimize-db
```

### å®šæœŸç¶­è­·

#### æ¯é€±ä¸€æ¬¡
```bash
# å¿«é€Ÿå„ªåŒ–ï¼ˆ1ç§’å…§å®Œæˆï¼‰
./start.sh --optimize-db
```

#### æ¯æœˆä¸€æ¬¡ï¼ˆå¦‚æœè³‡æ–™åº« >10MBï¼‰
```bash
# å®Œæ•´å„ªåŒ–ï¼ˆåŒ…å« VACUUMï¼‰
cd backend
python3 optimize_db_simple.py vacuum
```

#### æ¯å¤©å‚™ä»½
```bash
# è‡ªå‹•åŒ–å‚™ä»½è…³æœ¬
#!/bin/bash
DATE=$(date +%Y%m%d)
cp backend/divination.db backups/divination_$DATE.db
```

### ç›£æ§æŒ‡æ¨™

å®šæœŸæª¢æŸ¥é€™äº›æŒ‡æ¨™ï¼š

```bash
# 1. è³‡æ–™åº«å¤§å°
ls -lh backend/divination.db

# 2. è¨˜éŒ„æ•¸
cd backend && python3 optimize_db_simple.py stats

# 3. æŸ¥è©¢æ€§èƒ½
cd backend && python3 optimize_db_simple.py test
```

å¦‚æœç™¼ç¾ï¼š
- æª”æ¡ˆå¤§å°çªç„¶å¢é•·å¾ˆå¿« â†’ åŸ·è¡Œ VACUUM
- æŸ¥è©¢æ™‚é–“ > 50ms â†’ æª¢æŸ¥æ˜¯å¦ç¼ºå°‘ç´¢å¼•
- è¨˜éŒ„æ•¸è¶…éé æœŸ â†’ è€ƒæ…®æ¸…ç†èˆŠè³‡æ–™

---

## è³‡æ–™åº«å‚™ä»½èˆ‡æ¢å¾©

### å‚™ä»½

#### æ–¹æ³• 1ï¼šç›´æ¥è¤‡è£½ï¼ˆç°¡å–®ï¼‰
```bash
# åœæ­¢æœå‹™
./start.sh --stop

# è¤‡è£½è³‡æ–™åº«
cp backend/divination.db backend/divination.db.backup

# å•Ÿå‹•æœå‹™
./start.sh
```

#### æ–¹æ³• 2ï¼šSQLite Backupï¼ˆä¸åœæ©Ÿï¼‰
```bash
cd backend
sqlite3 divination.db ".backup divination_backup.db"
```

#### æ–¹æ³• 3ï¼šè‡ªå‹•åŒ–æ¯æ—¥å‚™ä»½
å‰µå»º `backup_db.sh`ï¼š
```bash
#!/bin/bash
BACKUP_DIR="/path/to/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_PATH="backend/divination.db"

mkdir -p "$BACKUP_DIR"
sqlite3 "$DB_PATH" ".backup '$BACKUP_DIR/divination_$DATE.db'"

# ä¿ç•™æœ€è¿‘ 7 å¤©çš„å‚™ä»½
find "$BACKUP_DIR" -name "divination_*.db" -mtime +7 -delete

echo "å‚™ä»½å®Œæˆ: $BACKUP_DIR/divination_$DATE.db"
```

åŠ å…¥ crontabï¼š
```bash
# æ¯å¤©å‡Œæ™¨ 2 é»å‚™ä»½
0 2 * * * /path/to/backup_db.sh
```

### æ¢å¾©

```bash
# åœæ­¢æœå‹™
./start.sh --stop

# æ¢å¾©å‚™ä»½
cp backend/divination_backup.db backend/divination.db

# å•Ÿå‹•æœå‹™
./start.sh
```

---

## ç–‘é›£æ’è§£

### å•é¡Œ 1ï¼šæŸ¥è©¢è®Šæ…¢

**è¨ºæ–·**ï¼š
```bash
cd backend && python3 optimize_db_simple.py test
```

**è§£æ±º**ï¼š
```bash
# å‰µå»ºç¼ºå¤±çš„ç´¢å¼•
./start.sh --optimize-db

# å¦‚æœé‚„æ˜¯æ…¢ï¼ŒåŸ·è¡Œ VACUUM
cd backend && python3 optimize_db_simple.py vacuum
```

### å•é¡Œ 2ï¼šè³‡æ–™åº«é–å®šéŒ¯èª¤

**ç—‡ç‹€**ï¼š`database is locked`

**åŸå› **ï¼šSQLite åŒæ™‚å¯«å…¥éå¤š

**è§£æ±º**ï¼š
1. çŸ­æœŸï¼šé‡è©¦æ©Ÿåˆ¶ï¼ˆFastAPI å·²è™•ç†ï¼‰
2. é•·æœŸï¼šè€ƒæ…®å‡ç´šåˆ° PostgreSQL

### å•é¡Œ 3ï¼šè³‡æ–™åº«æª”æ¡ˆæå£

**ç—‡ç‹€**ï¼šç„¡æ³•é–‹å•Ÿè³‡æ–™åº«

**è§£æ±º**ï¼š
```bash
# å˜—è©¦ä¿®å¾©
cd backend
sqlite3 divination.db ".recover" | sqlite3 divination_recovered.db

# å¦‚æœä¿®å¾©å¤±æ•—ï¼Œå¾å‚™ä»½æ¢å¾©
cp divination_backup.db divination.db
```

### å•é¡Œ 4ï¼šè³‡æ–™åº«éå¤§

**è¨ºæ–·**ï¼š
```bash
ls -lh backend/divination.db
cd backend && python3 optimize_db_simple.py stats
```

**è§£æ±º**ï¼š
```bash
# 1. åŸ·è¡Œ VACUUM
cd backend && python3 optimize_db_simple.py vacuum

# 2. æ¸…ç†èˆŠè³‡æ–™ï¼ˆå¦‚æœéœ€è¦ï¼‰
# å¯ä»¥åœ¨ Django/FastAPI ä¸­å¯¦ä½œè³‡æ–™æ¸…ç†é‚è¼¯
```

---

## æ•ˆèƒ½å„ªåŒ–æ¸…å–®

### âœ… å·²å®Œæˆ
- [x] å‰µå»ºæ‰€æœ‰å¿…è¦ç´¢å¼•
- [x] åŸ·è¡Œ ANALYZE å„ªåŒ–æŸ¥è©¢è¨ˆåŠƒ
- [x] å•Ÿç”¨å¤–éµç´„æŸ
- [x] ä½¿ç”¨ ORMï¼ˆé˜² SQL æ³¨å…¥ï¼‰

### ğŸ“‹ å»ºè­°åŸ·è¡Œ
- [ ] è¨­å®šè‡ªå‹•å‚™ä»½ï¼ˆæ¯æ—¥ï¼‰
- [ ] å®šæœŸåŸ·è¡Œ `--optimize-db`ï¼ˆæ¯é€±ï¼‰
- [ ] ç›£æ§è³‡æ–™åº«å¤§å°å’ŒæŸ¥è©¢æ€§èƒ½
- [ ] è³‡æ–™åº« >10MB æ™‚åŸ·è¡Œ VACUUM

### ğŸ”® æœªä¾†è€ƒæ…®
- [ ] ç•¶ç”¨æˆ¶ > 5000 æ™‚ï¼Œè©•ä¼°å‡ç´šåˆ° PostgreSQL
- [ ] å¯¦ä½œè³‡æ–™æ­¸æª”æ©Ÿåˆ¶ï¼ˆèˆŠè³‡æ–™ç§»åˆ°æ­¸æª”è¡¨ï¼‰
- [ ] è€ƒæ…®è®€å¯«åˆ†é›¢ï¼ˆå¦‚æœéœ€è¦ï¼‰

---

## ç¸½çµ

### ä½ çš„æƒ…æ³

âœ… **SQLite å®Œå…¨å¤ ç”¨**
- 1000 ç”¨æˆ¶ Ã— 100 ç­† = 100,000 ç­†è¨˜éŒ„
- SQLite å¯è™•ç†æ•¸ç™¾è¬ç­†
- å·²å‰µå»ºæ‰€æœ‰å¿…è¦ç´¢å¼•
- æŸ¥è©¢æ€§èƒ½å„ªç§€ï¼ˆ< 1msï¼‰

### å»ºè­°

1. **ä¸Šç·šæ™‚åŸ·è¡Œä¸€æ¬¡**ï¼š
   ```bash
   ./start.sh --optimize-db
   ```

2. **æ¯é€±ç¶­è­·ä¸€æ¬¡**ï¼š
   ```bash
   ./start.sh --optimize-db
   ```

3. **è¨­å®šè‡ªå‹•å‚™ä»½**ï¼š
   æ¯æ—¥å‚™ä»½è³‡æ–™åº«æª”æ¡ˆ

4. **æŒçºŒç›£æ§**ï¼š
   - è³‡æ–™åº«å¤§å°
   - æŸ¥è©¢æ€§èƒ½
   - ç”¨æˆ¶å¢é•·é€Ÿåº¦

5. **ä½•æ™‚å‡ç´š**ï¼š
   - ç”¨æˆ¶ > 10,000
   - æˆ–æŸ¥è©¢æ™‚é–“ > 100ms
   - æˆ–éœ€è¦å¤šä¼ºæœå™¨éƒ¨ç½²

---

## å¿«é€Ÿåƒè€ƒ

```bash
# æ—¥å¸¸æ“ä½œ
./start.sh                    # å•Ÿå‹•æœå‹™
./start.sh --optimize-db      # å„ªåŒ–è³‡æ–™åº«
./start.sh --status           # æŸ¥çœ‹ç‹€æ…‹

# è³‡æ–™åº«ç¶­è­·
cd backend
python3 optimize_db_simple.py stats    # æŸ¥çœ‹çµ±è¨ˆ
python3 optimize_db_simple.py test     # æ¸¬è©¦æ€§èƒ½
python3 optimize_db_simple.py vacuum   # æ¸…ç†ç¢ç‰‡

# å‚™ä»½èˆ‡æ¢å¾©
cp backend/divination.db backup.db     # å‚™ä»½
cp backup.db backend/divination.db     # æ¢å¾©
```
